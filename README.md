# å—è½¬æ¢å·¥å…·

[English](./README_en_US.md)

[æ›´æ–°æ—¥å¿—](./CHANGELOG.md)

ä½¿ç”¨è‡ªå®šä¹‰ä»£ç è¿›è¡Œå¤åˆ¶ã€ç²˜è´´å’Œæ›´æ–°æ“ä½œï¼Œä»¥å—ä¸ºå•ä½è¿›è¡Œæ“ä½œï¼Œç›®å‰åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

- è‡ªå®šä¹‰å—ç²˜è´´ï¼šå°†å‰ªè´´æ¿å†… html ç²˜è´´è‡³æ€æºç¬”è®°ï¼Œæ”¯æŒè‡ªå®šä¹‰è§„åˆ™ï¼Œé’ˆå¯¹è¡¨æ ¼åšäº†ä¼˜åŒ–ã€‚
- è‡ªå®šä¹‰å—å¤åˆ¶ï¼šå¤åˆ¶å—æ—¶å°†æŠŠå—å†…å®¹æŒ‰æŒ‡å®šæ–¹æ³•å¤„ç†åå†å†™å…¥å‰ªè´´æ¿ã€‚
- è‡ªå®šä¹‰å—æ›´æ–°ï¼šä½¿ç”¨è‡ªå®šä¹‰ä»£ç å¤„ç†å—å†…å®¹å¹¶æ›´æ–°ã€‚
- ~~è¡¨æ ¼æ’å…¥åŠ©æ‰‹ï¼šå°† html ç±»å‹çš„è¡¨æ ¼å—è½¬æ¢ä¸ºæ€æºå†…ç½®è¡¨æ ¼å—ã€‚~~ï¼ˆå·²ç§»é™¤ï¼‰
- ~~ç²˜è´´ä¸º Html å—ï¼šå°†å‰ªè´´æ¿ä¸­å†…å®¹ç²˜è´´ä¸º Html å—ã€‚~~ï¼ˆå·²ç§»é™¤ï¼‰
- ~~æµç¨‹å›¾ç”Ÿæˆå™¨ï¼šå°†å—å¼•ç”¨å½¢å¼çš„æµç¨‹è½¬æ¢ä¸º Mermaid æµç¨‹å›¾ã€‚~~ï¼ˆå·²ç§»é™¤ï¼‰

## è‡ªå®šä¹‰å—ç²˜è´´

å°†å‰ªè´´æ¿å†… html ç²˜è´´è‡³æ€æºç¬”è®°ï¼Œä¸æ™®é€šç²˜è´´çš„ä¸åŒåœ¨äºï¼Œé’ˆå¯¹è¡¨æ ¼åšäº†ä¼˜åŒ–ï¼Œå¦å¤–ï¼Œä½¿ç”¨[mixmark-io/turndown: ğŸ› An HTML to Markdown converter written in JavaScript (github.com)](https://github.com/mixmark-io/turndown)è€Œä¸æ˜¯ Lute ä½œä¸º html è½¬ markdown å·¥å…·ã€‚

### ä½¿ç”¨æ–¹æ³•

1. åœ¨æ’ä»¶è®¾ç½®ä¸­è®¾ç½® js ä»£ç æ‰€åœ¨æ–‡æ¡£ã€‚
2. åœ¨ä¸Šè¿°æ–‡æ¡£ä¸­ç¼–å†™ js ä»£ç ã€‚
3. ç‚¹å‡»ç²˜è´´ä½ç½®å¤„å—çš„å—æ ‡->æ’ä»¶->è‡ªå®šä¹‰ç²˜è´´

js ä»£ç åº”è¯¥å…·æœ‰å¦‚ä¸‹å½¢å¼ï¼Œå…³äº filter å’Œ replacement çš„è¯¦ç»†æè¿°ï¼Œå‚è§[turndownæ–‡æ¡£](https://github.com/mixmark-io/turndown)ã€‚

```js
{
  filter: function (node, options) {
    const fontSize = node.style.fontSize;
    const fontSizeNum = parseInt(fontSize);
    return fontSizeNum >= 22;
  },
  replacement: function (content, node, options) {
    return "# " + content;
  },
};
```

## è‡ªå®šä¹‰å—å¤åˆ¶

åœ¨æ€æºä¸­ç¼–å†™ js ä»£ç ï¼Œå¤åˆ¶å—æ—¶å°†æŠŠå—å†…å®¹æŒ‰æŒ‡å®šæ–¹æ³•å¤„ç†åå†å†™å…¥å‰ªè´´æ¿ã€‚

> â— å‡½æ•°å†…å®¹å¯è®¿é—®å…¨å±€å˜é‡ï¼Œè¯·æ³¨æ„é£é™©ã€‚

### ä½¿ç”¨æ–¹æ³•

1. åœ¨æ’ä»¶è®¾ç½®ä¸­è®¾ç½® js ä»£ç æ‰€åœ¨æ–‡æ¡£ã€‚
2. åœ¨ä¸Šè¿°æ–‡æ¡£ä¸­ç¼–å†™ js ä»£ç ã€‚
   - å¿…é¡»è¦æœ‰ return è¯­å¥
   - å¿…é¡»ä½¿ç”¨ä»£ç å—ï¼Œå¹¶æ˜ç¡®è¡¨ç¤ºæ˜¯ js ä»£ç 
   - å¯ä»¥ç»™å—è®¾ç½®â€˜å‘½åâ€™ä»¥æ–¹ä¾¿åŒºåˆ†
   - æ”¯æŒç›´æ¥ä½¿ç”¨çš„å­—æ®µï¼š
     - id: å— Id
     - titleï¼šå—æ‰€åœ¨æ–‡æ¡£å
     - nameï¼šå—å‘½å
     - markdownï¼šå— markdow æ–‡æœ¬
     - contentï¼šå—æ–‡æœ¬ï¼Œå»é™¤äº† markdown æ ‡è®°
     - inputï¼šæ•´ä¸ª block ä¿¡æ¯ï¼Œè¯¦è§æ€æºç¬”è®°ç”¨æˆ·æŒ‡å—/è¯·ä»è¿™é‡Œå¼€å§‹/æœç´¢è¿›é˜¶/æ•°æ®åº“è¡¨
     - index: å¤åˆ¶å¤šä¸ªå—æ—¶ï¼Œå—ç´¢å¼•ï¼Œå†…éƒ¨ä½¿ç”¨`result += func(input, i);`å¯¹å†…å®¹è¿›è¡Œæ‹¼æ¥(`func(input, i)`ä¸ºæœ¬æ­¥éª¤ä¸­ç¼–å†™çš„ js ä»£ç )
     - inputArray(v0.2.4 æ–°å¢): å¤åˆ¶å¤šä¸ªå—æ—¶ï¼ŒåŒ…å«æ‰€æœ‰å—`input`çš„åˆ—è¡¨
3. åˆ·æ–°ç•Œé¢(æ§åˆ¶å°è¿è¡Œ`location.reload()`ï¼Œå³ä¸æ”¯æŒçƒ­æ›´æ–°)
   - v0.2.4 ä»¥ä¸Šç‰ˆæœ¬ï¼šå¦‚æœæ˜¯å·²æœ‰è„šæœ¬ï¼Œåˆ™æ”¯æŒçƒ­æ›´æ–°ï¼Œä¸ç”¨å†åˆ·æ–°ç•Œé¢ï¼Œä½†å—æ ‡èœå•æ˜¾ç¤ºä¸ä¼šæ›´æ–°
4. ç‚¹å‡»è¦å¤åˆ¶çš„å—çš„å—æ ‡->æ’ä»¶->è‡ªå®šä¹‰å¤åˆ¶

- v0.2.6 ä»¥ä¸Šç‰ˆæœ¬ï¼šæ”¯æŒè®¾ç½®è‡ªå®šä¹‰å¿«æ·é”®
- å‡½æ•°å†…`Lute`ä¸`window.Lute`ä¸åŒï¼Œä¸ºç¼–è¾‘å™¨å†…ä½¿ç”¨çš„ Lute å®ä¾‹ï¼ˆè€Œé Lute ç±»,ä¸éœ€è¦è°ƒç”¨ Lute.New()ï¼‰

### å†…éƒ¨å®ç°

```js
//block js ä»£ç æ‰€åœ¨å—
const func = new Function(
  "input",
  "index",
  "inputArray",
  ` 
  let { title, name, content, markdown,id } = input;
  ${block.content}
  `
);
```

### ç¤ºä¾‹

ä»¥ä¸‹ä»£ç å°†è¯•å›¾è¿”å›ä¸€ä¸ª`((20230402121202-gofgg1n 'ã€Šæ°‘è¯‰è§£é‡Šã€‹ç¬¬374æ¡'))`å½¢å¼çš„æ–‡æœ¬å¹¶å†™å…¥å‰ªè´´æ¿ã€‚

```js
const matchGroup = content.match(/(ç¬¬)(.*?)(æ¡)/);
let realTitle = input.hpath.match(/ã€Š.*?ã€‹/);
if (!realTitle) {
  realTitle = title;
}
let result = "";
if (matchGroup) {
  result = `((${id} '${realTitle}${matchGroup[1]}${chineseToNum(
    matchGroup[2]
  )}${matchGroup[3]}'))`;
} else {
  result = `((${id} '${realTitle}${content.substring(0, 5)}'))`;
}

return result;

function chineseToNum(chnStr) {
  //è¯¥å‡½æ•°å†…å®¹çœç•¥
}
```

![è¿™æ˜¯å›¾ç‰‡](./asset/æ³•æ¡å¤åˆ¶.gif)

## è‡ªå®šä¹‰å—æ›´æ–°

åœ¨æ€æºä¸­ç¼–å†™ js ä»£ç ï¼Œä½¿ç”¨è¯¥ä»£ç å¤„ç†å—å†…å®¹å¹¶æ›´æ–°ã€‚

> â— æ— è®ºå¦‚ä½•ï¼Œä½¿ç”¨è„šæœ¬æ›´æ–°å—éƒ½æœ‰ä¸€å®šçš„é£é™©ï¼Œè¯·ä½¿ç”¨å¤šä¸ªå—æµ‹è¯•æ²¡æœ‰é—®é¢˜åå†ä½¿ç”¨è¯¥å·¥å…·è¿›è¡Œæ›´æ–°ï¼Œå¹¶æ¨èå¯¹å¾…æ›´æ–°å†…å®¹è¿›è¡Œå¤‡ä»½ã€‚
>
> â— å‡½æ•°å†…å®¹å¯è®¿é—®å…¨å±€å˜é‡ï¼Œè¯·æ³¨æ„é£é™©ã€‚

### ä½¿ç”¨æ–¹æ³•

åŸºæœ¬åŒè‡ªå®šä¹‰å—å¤åˆ¶ï¼Œæ³¨æ„ï¼Œè¿”å›å€¼æ ¼å¼å¦‚ä¸‹ï¼š

```js
{
  markdown?: string;
  attrs?: { [key: string]: string };
};
```

å…¶ä¸­ï¼Œmarkdown è¡¨ç¤ºæ›´æ–°åçš„å—å†…å®¹ï¼Œattr è¡¨ç¤ºæ›´æ–°åçš„å±æ€§ã€‚

> âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
>
> - å¯ä»¥å°†ä¸€ä¸ªå—æ›´æ–°ä¸ºå¤šä¸ªå—ï¼Œä½†åªæœ‰ç¬¬ä¸€ä¸ªå—ä¼šç»§æ‰¿æˆ–æ›´æ–°å±æ€§
> - v0.2.4 ä»¥ä¸Šç‰ˆæœ¬ï¼šæ–°å¢ `inputArray` å˜é‡(è¯¦è§ è‡ªå®šä¹‰å—å¤åˆ¶ éƒ¨åˆ†)ï¼Œå¯ä»¥åˆ©ç”¨å…¶å°†å¤šä¸ªå—æ›´æ–°ä¸ºä¸€ä¸ªå—ï¼Œä½†æ˜¯å¦‚æœä»»ä½•å—è¿”å› `markdown` å†…å®¹ä¸ºç©ºï¼Œä¸ºä¿è¯æ•°æ®å®‰å…¨ï¼Œä¸ä¼šä¸»åŠ¨å°†å…¶æ¸…ç©º
> - v0.2.6 ä»¥ä¸Šç‰ˆæœ¬ï¼šæ”¯æŒ`Ctrl+Z`æ’¤é”€(ğŸš€ å®éªŒæ€§)

### ç¤ºä¾‹

#### ç¤ºä¾‹ 1ï¼šå°†æ®µè½å—è½¬æ¢ä¸ºå¤šçº§åˆ—è¡¨

ä»¥ä¸‹ä»£ç å°†æŠŠæ–‡æœ¬å—æŒ‰ä¸€å®šè§„åˆ™è½¬åŒ–ä¸ºåˆ—è¡¨å—ï¼Œå¹¶æ¸…é™¤åŸæœ‰çš„åˆ«åå’Œå‘½åã€‚

```js
const list = markdown.split("\n");
let result = "";
let i = 0;
for (const text of list) {
  let textResult = i ? text : text.replace(/(ç¬¬.{1,6}æ¡)/, "**$1** ");
  textResult = "- " + textResult;
  if (text.startsWith("(") || text.startsWith("ï¼ˆ")) {
    textResult = "  " + textResult;
  }
  result += "\r\n" + textResult;
  i++;
}
result = result + "\r\n---\r\n";
return { markdown: result, attrs: { name: "", alias: "" } };
```

![è¿™æ˜¯å›¾ç‰‡](./asset/æ³•æ¡æ›´æ–°.gif)

#### ç¤ºä¾‹ 2ï¼šä½œä¸ºæ¨¡æ¿ä½¿ç”¨

ä»¥ä¸‹ä»£ç ç”Ÿæˆä¸€ä¸ªåµŒå…¥å—ï¼Œè¯¥åµŒå…¥å—å°†æ±‡æ€»å…¶çˆ¶çº§å—çš„æ‰€æœ‰åå‘é“¾æ¥ã€‚

```js
return {
  markdown: `{{SELECT * FROM blocks WHERE id IN(SELECT block_id FROM refs WHERE def_block_id='${input.parent_id}')}}`,
};
```
